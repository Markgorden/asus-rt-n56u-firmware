#! /bin/sh

asus_mfg=`nvram get asus_mfg`
echo "asus_mfg $asus_mfg"
if [ $asus_mfg != "0" ]; then
exit 1
fi

echo "argv $0 $1 $2"
# echo "argv $0 $1 $2" >> /tmp/auto01

if [ "$1" == "" ]; then
echo "parameter is none"
# echo "parameter is none" >> /tmp/auto01
exit 1
fi

existed=`cat /proc/partitions | grep $1 | wc -l`
echo "existed $existed"
# echo "existed $existed" >> /tmp/auto01
if [ $existed == "0" ]; then
exit 1
fi

mounted=`mount | grep $1 | wc -l`
echo "mounted $mounted"
# echo "mounted $mounted" >> /tmp/auto01

country_code=`nvram get wl_country_code`
echo "country_code $country_code"
# echo "country_code $country_code" >> /tmp/auto01

# mounted, assume we umount
if [ $mounted -ge 1 ]; then
echo "R/media/$2" 
echo "try to umount /media/$2"
# echo "try to umount /media/$2" >> /tmp/auto01 
if ! umount "/media/$2"; then
echo "umount /media/$2 fail"
# echo "umount /media/$2 fail" >> /tmp/auto01
exit 1
fi

if ! rmdir "/media/$2"; then
echo "rmdir /media/$2 fail!"
# echo "rmdir /media/$2 fail!" >> /tmp/auto01
exit 1
fi
# not mounted, lets mount under /media
else
if ! mkdir -p "/media/$2"; then
echo "mkdir /media/$2 fail"
# echo "mkdir /media/$2 fail" >> /tmp/auto01
exit 1
fi

chmod 777 /media/$2

mount "/dev/$1" "/media/$2" -o iocharset=utf8
mounted=`mount | grep $1 | wc -l`
if [ $mounted == "0" ]; then
# echo "mount try 1 fail" >> /tmp/auto01
mount "/dev/$1" "/media/$2"					# ext2, ext3
mounted=`mount | grep $1 | wc -l`
if [ $mounted == "0" ]; then
# echo "mount try 2 fail" >> /tmp/auto01
# failed to mount, clean up mountpoint
#ntfs-3g "/dev/$1" "/media/$2" -o force
mount -t ufsd -o iocharset=utf8 -o force "/dev/$1" "/media/$2"	# ntfs
mounted=`mount | grep $1 | wc -l`
if [ $mounted == "0" ]; then
# echo "mount try 3 fail" >> /tmp/auto01
if ! rmdir "/media/$2"; then
echo "rmdir /media/$2 fail!!"
# echo "rmdir /media/$2 fail!!" >> /tmp/auto01
exit 1
fi
fi
fi
fi
echo "A/media/$2" 
# echo "mounted /dev/$1 @ /media/$2" >> /tmp/auto01
fi

# rc need to know the event.
killall -SIGTTIN init
exit 0
